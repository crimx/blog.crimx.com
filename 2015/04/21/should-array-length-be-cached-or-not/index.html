<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 9]><!-->
<html class="no-js" lang="zh-cmn-Hans">
<!--<![endif]-->

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0">
<title>JavaScript 有必要缓存 for 循环中的 Array.length 吗？ | CRIMX</title>
<link rel="apple-touch-icon" sizes="57x57" href="/images/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/images/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/images/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/images/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/images/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/images/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/images/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/images/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192" href="/images/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/images/favicon/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<link rel="alternate" href="atom.xml" title="CRIMX" type="application/atom+xml">
<meta name="description" content="问题
缓存 Array.length 是老生常谈的小优化。





12345678910


// 不缓存 for (var i = 0; i &amp;lt; arr.length; i++) &amp;#123;...&amp;#125;// 缓存var len = arr.length;for (var i = 0; i &amp;lt; len; i++) &amp;#123;...&amp;#125;





但笔者对这种破碎">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaScript 有必要缓存 for 循环中的 Array.length 吗？">
<meta property="og:url" content="https://blog.crimx.com/2015/04/21/should-array-length-be-cached-or-not/index.html">
<meta property="og:site_name" content="CRIMX">
<meta property="og:description" content="问题
缓存 Array.length 是老生常谈的小优化。





12345678910


// 不缓存 for (var i = 0; i &amp;lt; arr.length; i++) &amp;#123;...&amp;#125;// 缓存var len = arr.length;for (var i = 0; i &amp;lt; len; i++) &amp;#123;...&amp;#125;





但笔者对这种破碎">
<meta property="og:image" content="https://blog.crimx.com/images/post/javascript/array-caching-performance-1.jpg">
<meta property="og:image" content="https://blog.crimx.com/images/post/javascript/array-caching-performance-2.jpg">
<meta property="og:updated_time" content="2016-12-31T16:52:11.295Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JavaScript 有必要缓存 for 循环中的 Array.length 吗？">
<meta name="twitter:description" content="问题
缓存 Array.length 是老生常谈的小优化。





12345678910


// 不缓存 for (var i = 0; i &amp;lt; arr.length; i++) &amp;#123;...&amp;#125;// 缓存var len = arr.length;for (var i = 0; i &amp;lt; len; i++) &amp;#123;...&amp;#125;





但笔者对这种破碎">
<meta name="twitter:image" content="https://blog.crimx.com/images/post/javascript/array-caching-performance-1.jpg">
<meta name="twitter:creator" content="@straybugs">
<link rel="stylesheet" href="/static/style.css">
<!-- <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script> -->
<script>
;
(function() {
    var h = document.getElementsByTagName('html')[0]
    h.className = (' ' + h.className + ' ').replace(' no-js ', ' ').slice(1, -1)
}())
</script>
<!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body>
<!--[if lt IE 9]>
    <p class="browser-warning" style="position:fixed;z-index:999999;top:0;left:0;right:0;padding:10px;text-align:center;color:red;background:yellow;">Why are you still using old version of IE??? Go and <a href="http://browsehappy.com/">upgrade your browser</a>.</p>
    <style>
      .site-menu-inner-wrapper{top:0;}
      .site-container{padding-top:45px;}
      .site-tags{font-size:14px;}
    </style>
  <![endif]-->
<div class="site-container">
<div class="site-menu js-progressive-bg-container" style="background: url('/images/post/cover/fog-1780738_1920-portrait.jpg') 35.55% 48.80%/cover">
<div class="site-menu-bg-thumb js-progressive-bg-thumbnail" style="background: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAeABEDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAYHBAP/xAAoEAABAwEGBQUAAAAAAAAAAAACAAEDBAUREhUxUwYHFCGREyJBUXH/xAAYAQACAwAAAAAAAAAAAAAAAAACAwABBP/EABgRAQEBAQEAAAAAAAAAAAAAAAAhEQIB/9oADAMBAAIRAxEAPwC41Amz3ssE1TgG7E3bVLtscybCCjfp6wCl+BSVLzDKunjjp42K97n92qdxQdRSs0j3B8oSPmL7UflCbAb6kUvDNonK4yM7P9rTZ9j1NnzeocZnhe/torHX0ULliYBZ/wAXLp4CpyF4h7trcs2Han+bSbZITZlFJtshXUj/2Q==') 35.55% 48.80%/cover"></div>
<div class="site-menu-inner-wrapper">
<div class="menu-logo">
<a class="icon-logo" href="/"></a>
</div>
<ul class="menu-social-icons">
<li>
<a class="icon-weibo" href="//www.weibo.com/straybugs" target="_blank"></a>
</li>
<li>
<a class="icon-github" href="//github.com/crimx" target="_blank"></a>
</li>
<li>
<a class="icon-mail" href="mailto:%73%74%72%61%79%62%75%67%73%40%67%6D%61%69%6C%2E%63%6F%6D" target="_blank"></a>
</li>
<li>
<a class="icon-rss" href="/atom.xml"></a>
</li>
</ul>
<ul class="menu-navs">
<li><a href="/categories/">Categories</a></li>
<li><a href="/archives/">Archives</a></li>
<li><a href="/tags/">Tags</a></li>
<li><a href="/search/">Search</a></li>
<li><a href="/about/">About</a></li>
</ul>
</div>
</div>
<div class="site-menu-mask"></div>
<div class="main-content">
<header class="site-cover js-progressive-bg-container" style="background: url('/images/post/cover/fog-1780738_1920-portrait.jpg') 35.55% 48.80%/cover">
<div class="site-cover-bg-thumb js-progressive-bg-thumbnail" style="background: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAeABEDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAYHBAP/xAAoEAABAwEGBQUAAAAAAAAAAAACAAEDBAUREhUxUwYHFCGREyJBUXH/xAAYAQACAwAAAAAAAAAAAAAAAAACAwABBP/EABgRAQEBAQEAAAAAAAAAAAAAAAAhEQIB/9oADAMBAAIRAxEAPwC41Amz3ssE1TgG7E3bVLtscybCCjfp6wCl+BSVLzDKunjjp42K97n92qdxQdRSs0j3B8oSPmL7UflCbAb6kUvDNonK4yM7P9rTZ9j1NnzeocZnhe/torHX0ULliYBZ/wAXLp4CpyF4h7trcs2Han+bSbZITZlFJtshXUj/2Q==') 35.55% 48.80%/cover"></div>
<a class="cover-logo" href="/"></a>
<div class="title-wrapper">
<h1 class="site-title" itemprop="name">JavaScript 有必要缓存 for 循环中的 Array.length 吗？</h1>
<div class="article-meta">
<div class="article-category"><a class="article-category-link" href="/categories/JavaScript/">JavaScript</a></div><a href="/2015/04/21/should-array-length-be-cached-or-not/" class="article-date"><time datetime="2015-04-20T16:00:00.000Z" itemprop="datePublished">2015-04-21</time></a><a
rel="license" class="cc-license-wrapper" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" title="This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License."><svg class="cc-license" fill="#fff"><use xlink:href="/images/symbol-defs.svg#icon-cc-license"/></svg></a></div>
</div>
</header>
<div class="tagline-wrap">
<section class="tagline">
<blockquote class="tagline-content">"TL;DR: No"</blockquote>
</section>
</div>
<div class="toc-mousearea"></div>
<div class="toc-wrapper">
<div class="toc-container">
<ol class="toc">
<li class="toc-item toc-level-2"><a class="toc-link" href="#问题"><span class="toc-text">问题</span></a></li>
<li class="toc-item toc-level-2"><a class="toc-link" href="#结论"><span class="toc-text">结论</span></a></li>
<li class="toc-item toc-level-2"><a class="toc-link" href="#理由"><span class="toc-text">理由</span></a>
<ol class="toc-child">
<li class="toc-item toc-level-3"><a class="toc-link" href="#从测试结果上看"><span class="toc-text">从测试结果上看</span></a></li>
<li class="toc-item toc-level-3"><a class="toc-link" href="#从-V8-的中间代码分析"><span class="toc-text">从 V8 的中间代码分析</span></a></li>
</ol>
</li>
<li class="toc-item toc-level-2"><a class="toc-link" href="#结尾"><span class="toc-text">结尾</span></a></li>
</ol>
</div>
</div>
<article id="post-should-array-length-be-cached-or-not" class="article--post" itemscope="" itemprop="blogPost">
<div class="article-inner js-no-wrap-menu">
<div class="article-entry postify" itemprop="articleBody">
<h2 id="问题">
<a href="#问题" class="headerlink" title="问题"></a>问题</h2>
<p>缓存 <code>Array.length</code> 是老生常谈的小优化。</p>
<p></p>
<figure class="highlight javascript">
<table>
<tr>
<td class="gutter">
<pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre>
</td>
<td class="code">
<pre><div class="line"><span class="comment">// 不缓存 </span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</div><div class="line">...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 缓存</span></div><div class="line"><span class="keyword">var</span> len = arr.length;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">...</div><div class="line">&#125;</div></pre>
</td>
</tr>
</table>
</figure>
<p></p>
<p>但笔者对这种破碎的写法感到不适，也对这种写法的实际优化效果产生疑问。</p>
<p>且推崇这种写法的朋友似乎很多也是“前辈这么说+自己想了一下觉得有道理”。</p>
<p>由于 for 循环搭配 <code>Array.length</code> 是极度常用的 JavasScript 代码，所以非常必要搞清楚。</p>
<h2 id="结论">
<a href="#结论" class="headerlink" title="结论"></a>结论</h2>
<p>先上笔者得到的结论：缓存 <code>Array.lengh</code> 对优化影响不大，甚至会减慢。</p>
<h2 id="理由">
<a href="#理由" class="headerlink" title="理由"></a>理由</h2>
<h3 id="从测试结果上看">
<a href="#从测试结果上看" class="headerlink" title="从测试结果上看"></a>从测试结果上看</h3>
<p>stackoverflow 上也有这个讨论，<a href="http://stackoverflow.com/questions/17989270/for-loop-performance-storing-array-length-in-a-variable" target="_blank">For-loop performance: storing array length in a variable</a> 。</p>
<p>accepted 的答案是说缓存会起到加速的结果，给出了 <a href="http://jsperf.com/for-loop-research" target="_blank">jsPerf</a> 测试。</p>
<p>但是有答案反对，也给出了 <a href="http://blogs.msdn.com/b/eternalcoding/archive/2015/01/07/javascript-shoud-i-have-to-cache-my-array-s-length.aspx" target="_blank">jsPerf</a> 测试。</p>
<p>两个答案的区别在于 （<a href="http://en.wikipedia.org/wiki/Loop-invariant_code_motion" target="_blank">Loop-invariant code motion</a>），accepted 答案的测试循环里没有访问到数组，是不实际的，后面会讲到。</p>
<p>从另一篇文章 <a href="http://blogs.msdn.com/b/eternalcoding/archive/2015/01/07/javascript-shoud-i-have-to-cache-my-array-s-length.aspx" target="_blank">Shoud I have to cache my array’s length?</a> 的测试结果也可以看出缓存差别不大。</p>
<p><img src="/images/post/javascript/array-caching-performance-1.jpg" alt="array-caching-performance-1"></p>
<p>还有这篇 <a href="http://www.erichynds.com/blog/javascript-length-property-is-a-stored-value" target="_blank">JavaScript&#39;s .length Property is a Stored Value</a></p>
<p><img src="/images/post/javascript/array-caching-performance-2.jpg" alt="array-caching-performance-2"></p>
<h3 id="从-V8-的中间代码分析">
<a href="#从-V8-的中间代码分析" class="headerlink" title="从 V8 的中间代码分析"></a>从 V8 的中间代码分析</h3>
<p>这篇文章 <a href="http://mrale.ph/blog/2014/12/24/array-length-caching.html" target="_blank">How the Grinch stole array.length access</a> 从 V8 的 hydrogen 探讨 <code>Array.length</code> 在 for 循环中的处理。</p>
<p>正如上面提到的 <a href="http://en.wikipedia.org/wiki/Loop-invariant_code_motion" target="_blank">Loop-invariant code motion</a>，引擎会聪明的把能确定不变的代码移到循环外。</p>
<p>所以像下面这种代码也不会影响引擎对 <code>Array.length</code> 的优化：</p>
<p></p>
<figure class="highlight javascript">
<table>
<tr>
<td class="gutter">
<pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre>
</td>
<td class="code">
<pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">uncached</span>(<span class="params">arr</span>) </span>&#123;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</div><div class="line">    arr[i]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre>
</td>
</tr>
</table>
</figure>
<p></p>
<p>而当循环中调用不可<a href="http://zh.wikipedia.org/zh/%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0" target="_blank">内联函数</a>时，引擎没法做优化，每次循环都会重新计算一遍 <code>length</code></p>
<p></p>
<figure class="highlight javascript">
<table>
<tr>
<td class="gutter">
<pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre>
</td>
<td class="code">
<pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">BLACKHOLE</span>(<span class="params">sum, arr</span>) </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123; &#125; <span class="keyword">catch</span> (e) &#123; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">uncached</span>(<span class="params">arr</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> sum = <span class="number">0</span>;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</div><div class="line">    sum += arr[i];</div><div class="line">    <span class="keyword">if</span> (sum &lt; <span class="number">0</span>) BLACKHOLE(arr, sum);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> sum;</div><div class="line">&#125;</div></pre>
</td>
</tr>
</table>
</figure>
<p></p>
<p>但这时即便是在循环外缓存了 <code>length</code> 也是没有用的，引擎没法预判数组的变化，当需要访问数组元素时会触发 bounds check ，从而照样要计算一遍 <code>length</code> 。所以缓存 <code>length</code> 是没有用的。</p>
<p>甚至，由于多了一个变量，底层的寄存器分配器每次循环还要多一次恢复这个变量。这个只有在大规模的情况下才会看出区别。</p>
<h2 id="结尾">
<a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2>
<p>当然这篇文章也有局限性，仅仅讨论了 V8 引擎，也没有讨论访问 <code>length</code> 代价更高的 <code>HTMLCollection</code> 。但这已经足够让我们不用再局限于缓存的写法，可以放开来按照自己喜欢的方式去写循环了。</p>
<p>【完】</p>
</div>
</div>
<footer class="article-footer">
<ul class="article-tag-list">
<li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Array/">Array</a></li>
<li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li>
<li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Recommended/">Recommended</a></li>
<li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Understanding-JavaScript/">Understanding JavaScript</a></li>
</ul>
<nav id="article-nav"><a href="/2015/05/14/understanding-prototype/" id="article-nav-newer" class="article-nav-link-wrap"><strong class="article-nav-caption">newer</strong><div class="article-nav-title">理解 Prototype</div></a>
<a href="/2015/03/29/javascript-hoist-under-the-hood/"
id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">older</strong>
<div class="article-nav-title">V8 是如何实现 JavaScript Hoist 的</div>
</a>
</nav>
</footer>
</article>
<section id="comments">
<div id="disqus_thread">
<div class="no-disqus">由于某种不可跨越的鸿沟，评论可能加载不了。</div><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank">comments powered by Disqus.</a></noscript></div>
</section>
<script>
var disqus_config = function() {

    this.page.url = 'https://blog.crimx.com/2015/04/21/should-array-length-be-cached-or-not/';

    this.page.identifier = '2015/04/21/should-array-length-be-cached-or-not/';
};

(function() {
    var d = document,
        s = d.createElement('script');

    s.src = '//crimx.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<div class="menu-icon"><i class="menu-icon__logo"></i></div>
<footer class="site-footer">
<ul class="recommended-post">
<li class="recommended-post__item">
<a class="recommended-post__link" href="#">
<div class="recommended-post__cover js-progressive-bg-container">
<div class="recommended-post__thumbnail js-progressive-bg-thumbnail"></div>
</div>
<h1 class="recommended-post__title"></h1>
</a>
</li>
<li class="recommended-post__item">
<a class="recommended-post__link" href="#">
<div class="recommended-post__cover js-progressive-bg-container">
<div class="recommended-post__thumbnail js-progressive-bg-thumbnail"></div>
</div>
<h1 class="recommended-post__title"></h1>
</a>
</li>
<li class="recommended-post__item">
<a class="recommended-post__link" href="#">
<div class="recommended-post__cover js-progressive-bg-container">
<div class="recommended-post__thumbnail js-progressive-bg-thumbnail"></div>
</div>
<h1 class="recommended-post__title"></h1>
</a>
</li>
<li class="recommended-post__item">
<a class="recommended-post__link" href="#">
<div class="recommended-post__cover js-progressive-bg-container">
<div class="recommended-post__thumbnail js-progressive-bg-thumbnail"></div>
</div>
<h1 class="recommended-post__title"></h1>
</a>
</li>
</ul>
<div class="site-description">I <a href="https://github.com/crimx/" target="_blank">code</a>, <a href="http://codepen.io/straybugs/" target="_blank">design</a>, <a href="https://twitter.com/straybugs/" target="_blank">tweet</a> &amp; <a href="https://blog.crimx.com" target="_blank">blog</a>.</div>
<div
class="copyright">© COPYRIGHT 2016 · Designed &amp; Wrote With <svg class="icon-heart"><use xlink:href="/images/symbol-defs.svg#icon-heart"/></svg></div>
</footer>
</div>
</div>
<script src="/static/bundle.js"></script>
<!-- Google Analytics -->
<script type="text/javascript">
(function(i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

ga('create', 'UA-49163616-3', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics --><noscript><style>.noscript-warning {
      position: fixed;
      z-index: 999999;
      top: 0;
      left: 0;
      right: 0;
      margin: auto;
      padding: 10px;
      font-size: 1.2em;
      color: #fff;
      background: orange;
      text-align: center;
    }</style><div class="noscript-warning">This site works best with JavaScript enabled</div></noscript></body>

</html>